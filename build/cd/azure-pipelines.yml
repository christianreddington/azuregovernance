name: Continuous Delivery v$(Rev:.r)

trigger:
  batch: "true"
  branches:
    include:
    - master
  paths:
    include:
    - src/terraform
    - build/cd/azure-pipelines.yml
    - build/templates/terraform-stage.yml

pr: none

variables:
- name: terraformVersion
  value: 0.12.17
- name: TF_INPUT
  value: "false"
- name: TF_IN_AUTOMATION
  value: "true"

stages:

- stage: Artifacts

  jobs:

  - job: PublishArtifact
    displayName: Terraform Management Groups
    pool:
      vmImage: 'ubuntu-latest'

    steps:

    - publish: src/terraform
      displayName: "Publish Azure Governance artifact."
      artifact: terraformAzureGovernance
      enabled: "true"

    - publish: src/test
      displayName: "Publish Azure Governance tests."
      artifact: testsAzureGovernance
      enabled: "true"

    - publish: build/
      displayName: "Publish Azure Governance build artifact."
      artifact: pipelinesAzureGovernance
      enabled: "true"

- stage: dev

  variables:
    - name: deploymentStage
      value: "dev"
    - name: stateStorageAccountName
      value: "tfazuregovernancedev"
    - name: stateContainerName
      value: "dev"
    - name: stateKey
      value: "terraform.tfstate"
    - group: azuregovernancedev
    - group: azuregovernancedevsecret

  jobs:

  - job: Terraform
    displayName: Terraform Management Groups Build
    pool:
      vmImage: 'ubuntu-latest'

    container:
      image: rjfmachado.azurecr.io/terraform:${{ variables['terraformVersion'] }}
      endpoint: rjfmachado.containers

    steps:

    - template: /build/templates/terraform-stage.yml
      parameters:
        client_secret: $(tfClientSecret)
        storage_account_name: $(stateStorageAccountName)
        container_name: $(stateContainerName)
        key: $(stateKey)
        deploymentStage: $(deploymentStage)

- stage: prod

  variables:
    - name: deploymentStage
      value: "prod"
    - name: stateStorageAccountName
      value: "tfazuregovernanceprod"
    - name: stateContainerName
      value: "prod"
    - name: stateKey
      value: "terraform.tfstate"
    - group: azuregovernanceprod
    - group: azuregovernanceprodsecret

  jobs:

  - job: Terraform
    displayName: Terraform Management Groups Build
    pool:
      vmImage: 'ubuntu-latest'

    container:
      image: rjfmachado.azurecr.io/terraform:${{ variables['terraformVersion'] }}
      endpoint: rjfmachado.containers

    steps:

    - template: /build/templates/terraform-stage.yml
      parameters:
        client_secret: $(tfClientSecret)
        storage_account_name: $(stateStorageAccountName)
        container_name: $(stateContainerName)
        key: $(stateKey)
        deploymentStage: $(deploymentStage)