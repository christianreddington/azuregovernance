name: Pull Request $(Rev:.r)

trigger: none

pr:
  autoCancel: "true"
  branches:
    include:
    - master
  paths:
    include:
    - src/terraform
    - build/cd/azure-pipelines.yml
    - build/templates/terraform-stage.yml
    exclude:
    - build/ci/azure-pipelines.yml
    - build/templates/terraform-stage-pr.yml

variables:
- name: terraformVersion
  value: 0.12.10

stages:
  - stage: dev

    variables:
    - name: deploymentStage
      value: "dev"
    - name: stateStorageAccountName
      value: "tfazuregovernancedev"
    - name: stateContainerName
      value: "dev"
    - name: stateKey
      value: "terraform.tfstate"
    - group: azuregovernancedev

    jobs:

    - job: Terraform
      displayName: Azure Governance Pull Request
      pool:
        vmImage: 'ubuntu-latest'

      container:
        image: rjfmachado.azurecr.io/terraform:${{ variables['terraformVersion'] }}
        endpoint: containers

      steps:

      - template: /build/templates/terraform-stage-pr.yml
        parameters:
          client_secret: $(ARM_CLIENT_SECRET)
          client_id: $(ARM_CLIENT_ID)
          tenant_id: $(ARM_TENANT_ID)
          subscription_id: $(ARM_SUBSCRIPTION_ID)
          storage_account_name: $(stateStorageAccountName)
          container_name: $(stateContainerName)
          key: $(stateKey)
          deploymentStage: $(deploymentStage)