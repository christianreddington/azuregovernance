name: Azure_Governance_PR_$(Rev:.r)

trigger: none

pr:
  autoCancel: "true"
  paths:
    include:
    - src/terraform
    - build/ci/azure-pipelines.yml
    - build/pr/azure-pipelines.yml
    - build/templates/terraform-stage.yml
    - build/templates/terraform-stage-pr.yml

variables:
- name: terraformVersion
  value: 0.12.6

stages:
  - stage: dev

    variables:
    - name: deploymentStage
      value: "dev"
    - name: stateStorageAccountName
      value: "tfazuregovernancedev"
    - name: stateContainerName
      value: "dev"
    - name: stateKey
      value: "terraform.tfstate"
    - group: azuregovernancedev

    jobs:

    - job: Terraform
      displayName: Terraform Management Groups Build
      pool:
        vmImage: 'ubuntu-latest'

      container:
        image: rjfmachado.azurecr.io/terraform:${{ variables['terraformVersion'] }}
        endpoint: containers

      steps:

      - template: /build/templates/terraform-stage-pr.yml
        parameters:
          client_secret: $(ARM_CLIENT_SECRET)
          client_id: $(ARM_CLIENT_ID)
          tenant_id: $(ARM_TENANT_ID)
          subscription_id: $(ARM_SUBSCRIPTION_ID)
          storage_account_name: $(stateStorageAccountName)
          container_name: $(stateContainerName)
          key: $(stateKey)
          deploymentStage: $(deploymentStage)