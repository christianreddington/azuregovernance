parameters:
  client_secret: ""
  client_id: ""
  tenant_id: ""
  subscription_id: ""
  storage_account_name: ""
  container_name: ""
  key: ""
  deploymentStage: ""

steps:
  - bash: |
      terraform init \
      -input=false \
      -backend=true \
      -backend-config="client_secret=${{parameters.client_secret}}" \
      -backend-config="storage_account_name=${{parameters.storage_account_name}}" \
      -backend-config="container_name=${{parameters.container_name}}" \
      -backend-config="key=${{parameters.key}}"
    displayName: "Terraform Init"
    name: init

    workingDirectory: src/terraform
    enabled: "true"

  - bash: |
      terraform plan \
      -input=false \
      -out=tfplan \
      -detailed-exitcode \
      -var "client_secret=${{parameters.client_secret}}" \
      -var "client_id=${{parameters.client_id}}" \
      -var "tenant_id=${{parameters.tenant_id}}" \
      -var "subscription_id=${{parameters.subscription_id}}" \
      -var "deploymentStage=${{parameters.deploymentStage}}" \
      && echo "##vso[task.setvariable variable=TF_PLAN_RESULT;isOutput=true]$?"
    displayName: "Terraform Plan"
    workingDirectory: src/terraform
    enabled: "true"
    name: plan

  - bash: |
      if [ $? -eq 2 ]; then \
      terraform apply \
      tfplan \
      -input=false \t
      -auto-approve \
      -var "client_secret=${{parameters.client_secret}}" \
      -var "client_id=${{parameters.client_id}}" \
      -var "tenant_id=${{parameters.tenant_id}}" \
      -var "subscription_id=${{parameters.subscription_id}}" \
      -var "deploymentStage=${{parameters.deploymentStage}}"\
      fi
    displayName: "Terraform Apply"
    workingDirectory: src/terraform
    enabled: "true"
    depends_on: eq(variables['plan.TF_PLAN_RESULT'], '2')
    name: apply
